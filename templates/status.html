{% macro watch(title, id, value, unit='', default='<b>??</b>') -%}
    <tr>
        <td>{{ title }}</td>
        <td id="{{ id }}" class="align_right large">
        {% if value %}
            {{ value }}
        {% else %}
            {{ default|safe }}
        {% endif %}
        </td>
        <td>{{ unit }}</td>
    </tr>
{%- endmacro %}
{% macro light_button(title, id, type, value) -%}
    <button class='{{ type }} {% if value is equalto true %}on{% else %}off{% endif %}' id='{{ id }}' disabled>{{ title }}</button>
{%- endmacro %}
<!doctype html>
<html>
<head>
<title>Hello, {% if master_mind %}Master{% else %}World{% endif %}</title>
<script type=text/javascript src="{{url_for('static', filename='jquery-3.2.1.min.js') }}"></script>
<link rel="stylesheet" href="{{url_for('static', filename='main.css') }}">
<script src="{{url_for('static', filename='jokes.js') }}"></script>
<script src="{{url_for('static', filename='amcharts/amcharts.js') }}"></script>
<script src="{{url_for('static', filename='amcharts/serial.js') }}"></script>
<script src="{{url_for('static', filename='amcharts/plugins/export/export.min.js') }}"></script>
<link rel="stylesheet" href="{{url_for('static', filename='amcharts/plugins/export/export.css') }}" type="text/css" media="all" />
<script src="{{url_for('static', filename='amcharts/themes/light.js') }}"></script>
<script type=text/javascript>
var chart = AmCharts.makeChart("chartdiv", {
  "type": "serial",
  //"theme": "light",
  "marginRight": 40,
  "marginLeft": 40,
  "autoMarginOffset": 20,
  "valueAxes": [{
    "id": "temperature",
    "position": "left",
    "ignoreAxisWidth": true,
    "precision": 2,
    "minPeriod": 0.01
  }],
  "balloon": {
    "borderThickness": 1,
    "shadowAlpha": 0
  },
  "graphs": [{
    "id": "tmpr_temperatureA",
    "balloon": {
      "drop": true,
      "animationDuration": 0
    },
    "bullet": "none",
    "lineThickness": 2,
    "valueField": "temperature1",
    "balloonText": "<span style='font-size:18px;'>[[value]] K</span>"
  },
  {
    "id": "tmpr_temperatureB",
    "balloon": {
      "drop": true,
      "animationDuration": 0
    },
    "bullet": "none",
    "lineThickness": 2,
    "valueField": "temperature2",
    "balloonText": "<span style='font-size:18px;'>[[value]] K</span>"
  }],
  "chartScrollbar": {
    "oppositeAxis": false,
    "offset": 30,
    "scrollbarHeight": 10,
    "autoGridCount": true,
    "color": "transparent",
    "updateOnReleaseOnly": true
  },
  "chartCursor": {
    "pan": true,
    "valueLineEnabled": true,
    "valueLineBalloonEnabled": true,
    "cursorAlpha": 1,
    "cursorColor": "#258cbb",
    "valueLineAlpha": 0.2,
    "valueZoomable": true,
    "categoryBalloonDateFormat": "HH:NN:SS",
    "animationDuration": 0
  },
  "valueScrollbar": {
    "oppositeAxis": false,
    "offset": 64,
    "scrollbarHeight": 10
  },
  "categoryField": "time",
  "categoryAxis": {
    "parseDates": true,
    "dashLength": 1,
    "minorGridEnabled": true,
    "autoGridCount": true,
    "minPeriod": "ss"
  },
  "export": {
    "enabled": true
  },
  "dataProvider": [],
  "export": {
    "enabled": true,
    "libs": {
      "path": "{{url_for('static', filename='amcharts/plugins/export/libs/') }}"
    },
    "menu": [{
    "class": "export-main",
    "label": "Export",
    "menu": [
      {
        "label": "Download as …",
        "menu": [{
          "format": "PNG",
          "label": "PNG"
        }, {
          "format": "SVG",
          "label": "SVG"
        }, {
          "format": "PDF",
          "label": "PDF"
        }]
      }, {
        "label": "Save as …",
        "menu": [{
          "label": "CSV",
          "click": function() {
              this.toCSV({
                data: plotData
              }, function(data) {
                this.download(data, this.defaults.formats.CSV.mimeType, "temperature.csv");
              });
            }
        }, {
          "label": "XLSX",
          "click": function() {
              this.toXLSX({
                data: plotData
              }, function(data) {
                this.download(data, this.defaults.formats.XLSX.mimeType, "temperature.xlsx");
              });
            }
        }]
      }, {
        "label": "Annotate …",
        "action": "draw"
      }, {
        "label": "Print",
        "format": "PRINT"
      }]
    }]
  }
});
chart.isZoomed = false;
chart.ignoreZoomed = true;
chart.addListener("zoomed", function(event) {
    if (chart.ignoreZoomed) {
        chart.ignoreZoomed = false;
        return;
    }
    chart.isZoomed = !(event.startIndex == 0 && event.chart.dataProvider.length - 1 == event.endIndex);
    chart.zoomStart = event.startIndex;
    chart.zoomEnd = event.endIndex;
});

chart.addListener("dataUpdated", function(event) {
    if (!chart.isZoomed) {
        return;
    }
    var zoomRange = chart.zoomEnd - chart.zoomStart + 1;
    chart.zoomToIndexes(event.chart.dataProvider.length - zoomRange, event.chart.dataProvider.length);
});
/******************************************************************************/
var lastRequestTime = Date();
var lastResponseTime = Date();
var plotData = [];
function update_values() {
    $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
    var now = new Date();
    if (now - lastRequestTime < 900) {
        return;
    }
    else {
        lastRequestTime = now;
    }
    $.getJSON($SCRIPT_ROOT+"/json",
        function(data) {
            var now = new Date();
            if (now - lastResponseTime < 900) {
                return;
            }
            else {
                lastResponseTime = now;
            }

            if (data.cmpr_pressures != null &&
                data.cmpr_pressures[0] != "None" &&
                data.cmpr_pressures[0] !== "") {
                $("#pressure1").text(data.cmpr_pressures[0]);
            }
            else {
                $("#pressure1").html("<b>??</b>");
            }
            if (data.cmpr_temperatures != null &&
                data.cmpr_temperatures[0] != "None" &&
                data.cmpr_temperatures[0] !== "") {
                for (var i = 0; i < 3; ++i) {
                    $("#cmpr_temperature" + (i+1)).text(data.cmpr_temperatures[i]);
                }
            }
            else {
                for (var i = 0; i < 3; ++i) {
                    $("#cmpr_temperature" + (i+1)).html("<b>??</b>");
                }
            }
            {% for id in ['cmpr_local_on',
                          'cmpr_cold_head_run',
                          'cmpr_cold_head_pause',
                          'cmpr_fault_off',
                          'cmpr_oil_fault_off',
                          'cmpr_solenoid_on',
                          'cmpr_pressure_off',
                          'cmpr_oil_level_alarm',
                          'cmpr_water_flow_alarm',
                          'cmpr_water_temperature_alarm',
                          'cmpr_helium_temperature_off',
                          'cmpr_mains_off',
                          'cmpr_motor_temperature_off',
                          'cmpr_system_on'] %}
                if (data.{{ id }}) {
                    $($("button#{{ id }}")[0]).addClass("on").removeClass("off");
                }
                else {
                    $($("button#{{ id }}")[0]).addClass("off").removeClass("on");
                }
            {% endfor %}
/******************************************************************************/
            var dict = {};
            if (data.tmpr_temperatures != null) {
                for (var i = 0; i < 2; ++i) {
                    dict["time"] = new Date();
                    if (data.tmpr_temperatures[i] != "None" &&
                        data.tmpr_temperatures[i] !== "" &&
                        data.tmpr_temperatures[i] != null) {
                            $("#tmpr_temperature" + (i+1)).text(data.tmpr_temperatures[i]);
                            var key = "temperature" + (i+1);
                            dict[key] = data.tmpr_temperatures[i];
                    }
                    else {
                        $("#tmpr_temperature" + (i+1)).html("<b>??</b>");
                    }
                }
            }
            else {
                for (var i = 0; i < 2; ++i) {
                    $("#tmpr_temperature" + (i+1)).html("<b>??</b>");
                }
                dict = {};
            }
            if (Object.keys(dict).length > 1 && !$("#tmpr_discard_data")[0].checked) {
                plotData.push(dict);
                var maxLength = 200;
                var displayedLength = 0;
                for (var i = 0; i < plotData.length; ++i) {
                    if (plotData[i].time >= chart.chartScrollbar.startTime &&
                        plotData[i].time <= chart.chartScrollbar.endTime) {
                        ++displayedLength;
                    }
                }
                if (displayedLength > maxLength) {
                    chart.dataProvider = [];
                    var denom = displayedLength / maxLength;
                    for (var i = 0; Math.round(i) < plotData.length; i += denom) {
                        chart.dataProvider.push(plotData[Math.round(i)]);
                    }
                }
                else {
                    chart.dataProvider.push(dict);
                }
                chart.ignoreZoomed = true;
                chart.validateData();
            }
            $("#time").text(new Date().toLocaleTimeString());

            if (data.tmpr_output != null) {
                for (var i = 0; i < 2; ++i) {
                    if (data.tmpr_output[i] != "None" &&
                        data.tmpr_output[i] !== "" &&
                        data.tmpr_output[i] != null) {
                            $("#tmpr_output" + (i+1)).text(data.tmpr_output[i]);
                            var key = "output" + (i+1);
                    }
                    else {
                        $("#tmpr_output" + (i+1)).html("<b>??</b>");
                    }
                }
            }
            else {
                for (var i = 0; i < 2; ++i) {
                    $("#tmpr_output" + (i+1)).html("<b>??</b>");
                }
            }
        });
}
setInterval(update_values, 1000)
$(document).ready(function() {
    $("input#tmpr_clear").click(function() {
        chart.dataProvider = [];
        plotData = [];
        chart.validateData();
    });

});
</script>
{% if master_mind -%}
<script type=text/javascript>
$(document).ready(function() {
    $("input#cmpr_on").click(function() {
        $.post("cmpr_do",
        {
          cmd: "$ON1",
        },
        function(data, status) {
            alert("Data: " + data + "\nStatus: " + status);
        });
    });
    $("input#cmpr_off").click(function() {
        $.post("cmpr_do",
        {
          cmd: "$OFF",
        },
        function(data, status) {
            alert("Data: " + data + "\nStatus: " + status);
        });
    });
});
</script>
<script type=text/javascript>
$(document).ready(function() {
    $("input#tmpr_pid_on").click(function() {
        var output_list = $("select#tmpr_output_list")[0];
        var output = output_list.options[output_list.selectedIndex].value;
        var input_list = $("select#tmpr_input_list")[0];
        var input = input_list.options[input_list.selectedIndex].value;
        var pid_mode_list = $("select#tmpr_pid_mode_list")[0];
        var pid_mode = pid_mode_list.options[pid_mode_list.selectedIndex].value;
        var powerup_list = $("select#tmpr_powerup_list")[0];
        var powerup = powerup_list.options[powerup_list.selectedIndex].value;
        var pid_range_list = $("select#tmpr_pid_range_list")[0];
        var pid_range = pid_range_list.options[pid_range_list.selectedIndex].value;
        var pid_value_field = $("input#tmpr_pid_value_field")[0];
        var pid_value = pid_value_field.value;
        var pid_p_field = $("input#tmpr_pid_p_field")[0];
        var pid_p = pid_p_field.value;
        var pid_i_field = $("input#tmpr_pid_i_field")[0];
        var pid_i = pid_i_field.value;
        var pid_d_field = $("input#tmpr_pid_d_field")[0];
        var pid_d = pid_d_field.value;
        $.ajax({
            type: 'post',
            url: 'tmpr_do',
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify({
              cmds:
              [
                {
                  cmd: "outmode",
                  payload:
                  [
                    /* output:         */   output,     // 1 or 2
                    /* mode:           */   pid_mode,   // 0 = Off, 1 = Closed Loop PID, 2 = Zone, 3 = Open Loop, 4 = Monitor Out, 5 = Warmup Supply
                    /* input:          */   input,      // 0 = None, 1 = A, 2 = B
                    /* powerup_enable: */   powerup     // 0 = Off, 1 = On
                  ]
                },
                {
                  cmd: "pid",
                  payload:
                  [
                    /* output:         */   output,     // 1 or 2
                    /* P:              */   pid_p,      // Proportional (gain)
                    /* I:              */   pid_i,      // Integral (reset)
                    /* D:              */   pid_d       // Derivative (rate)
                  ]
                },
                {
                  cmd: "setp",
                  payload:
                  [
                    /* output:         */   output,     // 1 or 2
                    /* value:          */   pid_value   // respect the sensor units!
                  ]
                },
                {
                  cmd: "range",
                  payload:
                  [
                    /* output:         */   output,     // 1 or 2
                    /* range:          */   pid_range   // 0 = Off, 1 = Low, 2 = Medium, 3 = High
                  ]
                }
              ]
            }),
            success: function(data, status) {
                alert("Data: " + data + "\nStatus: " + status);
            }
        });
    });
    $("input#tmpr_pid_off").click(function(){
        var output_list = $("select#tmpr_output_list")[0];
        var output = output_list.options[output_list.selectedIndex].value;
        $.ajax({
            type: 'post',
            url: 'tmpr_do',
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify({
              cmds:
              [
                {
                  cmd: "outmode",
                  payload:
                  [
                    /* output:         */   output,     // 1 or 2
                    /* mode:           */   0,          // 0 = Off, 1 = Closed Loop PID, 2 = Zone, 3 = Open Loop, 4 = Monitor Out, 5 = Warmup Supply
                    /* input:          */   0,          // 0 = None, 1 = A, 2 = B
                    /* powerup_enable: */   0           // 0 = Off, 1 = On
                  ]
                },
                {
                  cmd: "range",
                  payload:
                  [
                    /* output:         */   output,     // 1 or 2
                    /* range:          */   0           // 0 = Off, 1 = Low, 2 = Medium, 3 = High
                  ]
                }
              ]
            }),
            success: function(data, status) {
                alert("Data: " + data + "\nStatus: " + status);
            }
        });
    });
});
</script>
{%- endif %}
</head>
<body>
<table class="centered">
<tr>
<td>
    <input type="checkbox" id="checkbox-1" class="accordion" checked />
    <label for="checkbox-1">Compressor State</label>
    <table class="state">
        <tr>
            <td>
                <table class="wide">
                    {{ watch(title='Pressure:', id='pressure1', value=cmpr_pressures[0], unit='psig') }}
                    {{ watch(title='Helium Temperature:', id='cmpr_temperature1', value=cmpr_temperatures[0], unit='°C') }}
                    {{ watch(title='Water Out Temperature:', id='cmpr_temperature2', value=cmpr_temperatures[1], unit='°C') }}
                    {{ watch(title='Water In Temperature:', id='cmpr_temperature3', value=cmpr_temperatures[2], unit='°C') }}
                </table>
            </td>
            <td>
                <table id='cmpr_light'>
                    <tr>
                        <td colspan=2>{{ light_button(title='System On', id='cmpr_system_on', type='state', value=cmpr_system_on) }}</td>
                        <td colspan=2>{{ light_button(title='Local On', id='cmpr_local_on', type='state', value=cmpr_local_on) }}</td>
                    </tr>
                    <tr>
                        <td>{{ light_button(title='Fault Off', id='cmpr_fault_off', type='error', value=cmpr_fault_off) }}</td>
                        <td>{{ light_button(title='Solenoid On', id='cmpr_solenoid_on', type='state', value=cmpr_solenoid_on) }}</td>
                        <td>{{ light_button(title='Cold Head Run', id='cmpr_cold_head_run', type='state', value=cmpr_cold_head_run) }}</td>
                        <td>{{ light_button(title='Cold Head Pause', id='cmpr_cold_head_pause', type='stat2', value=cmpr_cold_head_pause) }}</td>
                    </tr>
                    <tr>
                        <td>{{ light_button(title='Helium Temperature', id='cmpr_helium_temperature_off', type='error', value=cmpr_helium_temperature_off) }}</td>
                        <td>{{ light_button(title='Helium Pressure', id='cmpr_helium_pressure_off', type='error', value=cmpr_pressure_off) }}</td>
                        <td>{{ light_button(title='Oil Level', id='cmpr_oil_level_alarm', type='alarm', value=cmpr_oil_level_alarm) }}</td>
                        <td>{{ light_button(title='Oil Fault Off', id='cmpr_oil_fault_off', type='error', value=cmpr_oil_fault_off) }}</td>
                    </tr>
                    <tr>
                        <td>{{ light_button(title='Water Flow', id='cmpr_water_flow_alarm', type='alarm', value=cmpr_water_flow_alarm) }}</td>
                        <td>{{ light_button(title='Water Temperature', id='cmpr_water_temperature_alarm', type='alarm', value=cmpr_water_temperature_alarm) }}</td>
                        <td>{{ light_button(title='Motor Temperature', id='cmpr_motor_temperature_off', type='error', value=cmpr_motor_temperature_off) }}</td>
                        <td>{{ light_button(title='Mains Power', id='cmpr_mains_off', type='error', value=cmpr_mains_off) }}</td>
                    </tr>
                </table>
            </td>
        </tr>
{% if master_mind -%}
        <tr>
            <td class="align_center" colspan=3>
                <input type="button" class="action_button" id="cmpr_on" value="Turn compressor on!">
                <input type="button" class="action_button" id="cmpr_off" value="Turn compressor off!">
            </td>
        </tr>
{%- endif %}
    </table>
</td>
</tr>
<tr>
<td>
    <input type="checkbox" id="checkbox-2" class="accordion" checked />
    <label for="checkbox-2">Cold Plate State</label>
    <table class="state">
        <tr>
            <td>
                <table class="wide">
                    {{ watch(title='Temperature A:', id='tmpr_temperature1', value=tmpr_temperatures[0], unit='K') }}
                    {{ watch(title='Temperature B:', id='tmpr_temperature2', value=tmpr_temperatures[1], unit='K') }}
                    {{ watch(title='Output 1:', id='tmpr_output1', value=tmpr_output[0], unit='%') }}
                    {{ watch(title='Output 2:', id='tmpr_output2', value=tmpr_output[1], unit='%') }}
                </table>
            </td>
        </tr>
{% if master_mind -%}
        <tr>
            <td>
                <table class="wide">
                    <tr>
                        <td>
                            <table class="wide">
                                <tr>
                                    <td>Output:</td>
                                    <td>
                                        <select id="tmpr_output_list">
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Input:</td>
                                    <td>
                                        <select id="tmpr_input_list">
                                            <option value="0">None</option>
                                            <option value="1">A</option>
                                            <option value="2">B</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Mode:</td>
                                    <td>
                                        <select id="tmpr_pid_mode_list">
                                            <option value="0">Off</option>
                                            <option value="1">Closed Loop PID</option>
                                            <option value="2">Zone</option>
                                            <option value="3">Open Loop</option>
                                            <option value="4">Monitor Out</option>
                                            <option value="5">Warmup Supply</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Range:</td>
                                    <td>
                                        <select id="tmpr_pid_range_list">
                                            <option value="0">Off</option>
                                            <option value="1">Low</option>
                                            <option value="2">Medium</option>
                                            <option value="3">High</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Powerup:</td>
                                    <td>
                                        <select id="tmpr_powerup_list">
                                            <option value="0">Off</option>
                                            <option value="1">On</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Desired value:</td>
                                    <td>
                                        <input type='number' id="tmpr_pid_value_field" value="292.73" step="0.01" min="0.00"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>P:</td>
                                    <td>
                                        <input type='number' id="tmpr_pid_p_field" value="50" step="any"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>I:</td>
                                    <td>
                                        <input type='number' id="tmpr_pid_i_field" value="20" step="any"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>D:</td>
                                    <td>
                                        <input type='number' id="tmpr_pid_d_field" value="0" step="any"/>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td class="align_center">
                            <input type="button" class="action_button" id="tmpr_pid_on" value="Turn PID on!">
                            <input type="button" class="action_button" id="tmpr_pid_off" value="Turn PID off!">
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
{%- endif %}
        <tr>
            <td>
                <div id="chartdiv"></div>
            </td>
        </tr>
        <tr>
            <td class="align_center">
                <table class="fixed centered">
                    <tr>
                        <td>
                            <input type="checkbox" id="tmpr_discard_data">
                            <label for="tmpr_discard_data">Don't record temperatures</label>
                        </td>
                        <td>
                            <input type="button" id="tmpr_clear" value="Clear Data">
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</td>
</tr>
</table>

<p id="time" onclick="loadJoke('#time + div');"></p>
<div style="white-space: pre-line;"></div>
</body>
</html>
