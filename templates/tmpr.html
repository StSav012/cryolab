{% macro watch(title, id, value, unit='', default='<b>??</b>') -%}
    <tr>
        <td>{{ title }}</td>
        <td id="{{ id }}" class="align_right large">
        {% if value %}
            {{ value }}
        {% else %}
            {{ default|safe }}
        {% endif %}
        </td>
        <td>{{ unit }}</td>
    </tr>
{%- endmacro %}
<!doctype html>
<html>
<head>
<title>Hello, {% if master_mind %}Master{% else %}World{% endif %} — Temperature Controller</title>
<link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
<link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
<link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}">
<link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
<link rel="mask-icon" href="{{ url_for('static', filename='safari-pinned-tab.svg') }}" color="#5bbad5">
<meta name="theme-color" content="#ffffff">
<script type=text/javascript src="{{ url_for('static', filename='jquery-3.2.1.min.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='temperature_controller.css') }}">
<script src="{{ url_for('static', filename='amcharts/amcharts.js') }}"></script>
<script src="{{ url_for('static', filename='amcharts/serial.js') }}"></script>
<script src="{{ url_for('static', filename='amcharts/plugins/export/export.min.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='amcharts/plugins/export/export.css') }}" type="text/css" media="all" />
<script src="{{ url_for('static', filename='amcharts/themes/light.js') }}"></script>
<script type=text/javascript>
var chart = AmCharts.makeChart("chart", {
  "type": "serial",
  //"theme": "light",
  "marginRight": 40,
  "marginLeft": 40,
  "autoMarginOffset": 20,
  "valueAxes": [{
    "id": "temperature",
    "position": "left",
    "ignoreAxisWidth": true,
    "precision": 2,
    "minPeriod": 0.001,
    "includeAllValues": true,
    "unit": "K"
  }],
  "balloon": {
    "borderThickness": 1,
    "shadowAlpha": 0
  },
  "graphs": [{
    "id": "temperatureA",
    "balloon": {
      "drop": true,
      "animationDuration": 0
    },
    "bullet": "none",
    "lineThickness": 2,
    "valueField": "temperature1",
    "balloonText": "<span style='font-size:18px;'>[[value]] K</span>"
  },
  {
    "id": "temperatureB",
    "balloon": {
      "drop": true,
      "animationDuration": 0
    },
    "bullet": "none",
    "lineThickness": 2,
    "valueField": "temperature2",
    "balloonText": "<span style='font-size:18px;'>[[value]] K</span>"
  }],
  "chartScrollbar": {
    "oppositeAxis": false,
    "offset": 30,
    "scrollbarHeight": 10,
    "autoGridCount": true,
    "color": "transparent",
    "updateOnReleaseOnly": true
  },
  "chartCursor": {
    "pan": true,
    "valueLineEnabled": true,
    "valueLineBalloonEnabled": true,
    "cursorAlpha": 1,
    "cursorColor": "#258cbb",
    "valueLineAlpha": 0.2,
    "valueZoomable": true,
    "categoryBalloonDateFormat": "HH:NN:SS",
    "animationDuration": 0
  },
  "valueScrollbar": {
    "oppositeAxis": false,
    "offset": 78,
    "scrollbarHeight": 10
  },
  "categoryField": "time",
  "categoryAxis": {
    "parseDates": true,
    "dashLength": 1,
    "minorGridEnabled": true,
    "autoGridCount": true,
    "minPeriod": "fff"
  },
  "export": {
    "enabled": true
  },
  "dataProvider": [],
  "export": {
    "enabled": true,
    "libs": {
      "path": "{{ url_for('static', filename='amcharts/plugins/export/libs/') }}"
    },
    "menu": [{
    "class": "export-main",
    "label": "Export",
    "menu": [
      {
        "label": "Download as …",
        "menu": [{
          "format": "PNG",
          "label": "PNG"
        }, {
          "format": "SVG",
          "label": "SVG"
        }, {
          "format": "PDF",
          "label": "PDF"
        }]
      }, {
        "label": "Save as …",
        "menu": [{
          "label": "CSV",
          "click": function() {
              this.toCSV({
                data: plotData,
                dateFormat: "JJ:NN:SS"
              }, function(data) {
                this.download(data, this.defaults.formats.CSV.mimeType, "temperature.csv");
              });
            }
        }, {
          "label": "XLSX",
          "click": function() {
              this.toXLSX({
                data: plotData,
                dateFormat: "JJ:NN:SS"
              }, function(data) {
                this.download(data, this.defaults.formats.XLSX.mimeType, "temperature.xlsx");
              });
            }
        }]
      }, {
        "label": "Annotate …",
        "action": "draw"
      }, {
        "label": "Print",
        "format": "PRINT"
      }]
    }]
  }
});
chart.isZoomed = false;
chart.ignoreZoomed = true;
chart.addListener("zoomed", function(event) {
    if (chart.ignoreZoomed) {
        chart.ignoreZoomed = false;
        return;
    }
    chart.isZoomed = (event.endIndex - event.startIndex < event.chart.dataProvider.length - 1);
    chart.zoomStart = event.startIndex;
    chart.zoomEnd = event.endIndex;
});

chart.addListener("dataUpdated", function(event) {
    if (!chart.isZoomed) {
        return;
    }
    chart.zoomToIndexes(chart.zoomStart + 1, chart.zoomEnd + 2);
});
/******************************************************************************/
var timePeriod = 250;
var lastRequestTime = Date();
var lastResponseTime = Date();
var plotData = [];
function update_values() {
    $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
    var now = new Date();
    if (now - lastRequestTime < 0.9 * timePeriod || now - lastResponseTime < 0.9 * timePeriod) {
        return;
    }
    else {
        lastRequestTime = now;
    }
    $.getJSON($SCRIPT_ROOT+"/temperature_controller/json",
        function(data) {
            now = new Date();
            if (now - lastResponseTime < 0.9 * timePeriod) {
                return;
            }
            else {
                lastResponseTime = now;
            }

            var dict = {};
            var in_ok = false;
            if (data.temperatures != null) {
                for (var i = 0; i < 2; ++i) {
                    dict["time"] = new Date();
                    if (data.temperatures[i] != "None" &&
                        data.temperatures[i] !== "" &&
                        data.temperatures[i] != null) {
                            $("#temperature" + (i+1)).text(data.temperatures[i]);
                            var key = "temperature" + (i+1);
                            dict[key] = data.temperatures[i];
                            in_ok = true;
                            {% if master_mind -%}
                                $($("select#input_list option")[i+1]).show();
                            {%- endif %}
                    }
                    else {
                        $("#temperature" + (i+1)).html("<b>??</b>");
                        {% if master_mind -%}
                            $($("select#input_list option")[i+1]).hide();
                        {%- endif %}
                    }
                }
            }
            else {
                for (var i = 0; i < 2; ++i) {
                    $("#temperature" + (i+1)).html("<b>??</b>");
                    {% if master_mind -%}
                        $($("select#input_list option")[i+1]).hide();
                    {%- endif %}
                }
                dict = {};
            }
            if (Object.keys(dict).length > 1 && !$("#discard_data")[0].checked) {
                plotData.push(dict);
                var maxLength = 200;
                var displayedLength = 0;
                for (var i = 0; i < plotData.length; ++i) {
                    if (plotData[i].time >= chart.chartScrollbar.startTime &&
                        plotData[i].time <= chart.chartScrollbar.endTime) {
                        ++displayedLength;
                    }
                }
                if (displayedLength > maxLength) {
                    chart.dataProvider = [];
                    var denom = displayedLength / maxLength;
                    for (var i = 0; Math.round(i) < plotData.length; i += denom) {
                        chart.dataProvider.push(plotData[Math.round(i)]);
                    }
                }
                else {
                    chart.dataProvider.push(dict);
                }
                chart.ignoreZoomed = true;
                chart.validateData();
            }
            if (in_ok) {
                $("input#discard_data + label").show();
            }
            else {
                $("input#discard_data + label").hide();
            }

            if (data.output != null) {
                for (var i = 0; i < 2; ++i) {
                    if (data.output[i] != "None" &&
                        data.output[i] !== "" &&
                        data.output[i] != null) {
                            $("#output" + (i+1)).text(data.output[i]);
                            {% if master_mind -%}
                                $("table#pid_ch" + (i+1)).show();
                            {%- endif %}
                    }
                    else {
                        $("#output" + (i+1)).html("<b>??</b>");
                        {% if master_mind -%}
                            $("table#pid_ch" + (i+1)).hide();
                        {%- endif %}
                    }
                }
            }
            else {
                for (var i = 0; i < 2; ++i) {
                    $("#output" + (i+1)).html("<b>??</b>");
                    {% if master_mind -%}
                        $("table#pid_ch" + (i+1)).hide();
                    {%- endif %}
                }
            }
        });
    if (plotData.length == 0) {
        $("div#chart").hide();
    }
    else if (plotData.length == 1) {        // to fire only once
        $("div#chart").show();
        $("input#clear").show();
    }
}
setInterval(update_values, timePeriod);
$(document).ready(function() {
    $("input#clear").click(function() {
        chart.dataProvider = [];
        plotData = [];
        chart.validateData();
        $("input#clear").hide();
    });

});
</script>
{% if master_mind -%}
<script type=text/javascript>
function pid_on(output) {
    if ($($("table#pid_ch" + output)[0]).is(':hidden')) {
        alert("Invalid output");
        return;
    }
    var input_list = $("table#pid_ch" + output + " select#input_list")[0];
    var input = input_list.options[input_list.selectedIndex].value;
    if ($($("table#pid_ch" + output + " select#input_list option")[input_list.selectedIndex]).is(':hidden')) {
        alert("Invalid input");
        return;
    }
    var pid_mode_list = $("table#pid_ch" + output + " select#pid_mode_list")[0];
    var pid_mode = pid_mode_list.options[pid_mode_list.selectedIndex].value;
    var powerup_list = $("table#pid_ch" + output + " select#powerup_list")[0];
    var powerup = powerup_list.options[powerup_list.selectedIndex].value;
    var pid_range_list = $("table#pid_ch" + output + " select#pid_range_list")[0];
    var pid_range = pid_range_list.options[pid_range_list.selectedIndex].value;
    var pid_value_field = $("table#pid_ch" + output + " input#pid_value_field")[0];
    var pid_value = pid_value_field.value;
    var pid_p_field = $("table#pid_ch" + output + " input#pid_p_field")[0];
    var pid_p = pid_p_field.value;
    var pid_i_field = $("table#pid_ch" + output + " input#pid_i_field")[0];
    var pid_i = pid_i_field.value;
    var pid_d_field = $("table#pid_ch" + output + " input#pid_d_field")[0];
    var pid_d = pid_d_field.value;
    $.ajax({
        type: 'post',
        url: 'tmpr_do',
        contentType: "application/json; charset=utf-8",
        data: JSON.stringify({
          cmds:
          [
            {
              cmd: "outmode",
              payload:
              [
                /* output:         */   output,     // 1 or 2
                /* mode:           */   pid_mode,   // 0 = Off, 1 = Closed Loop PID, 2 = Zone, 3 = Open Loop, 4 = Monitor Out, 5 = Warmup Supply
                /* input:          */   input,      // 0 = None, 1 = A, 2 = B
                /* powerup_enable: */   powerup     // 0 = Off, 1 = On
              ]
            },
            {
              cmd: "pid",
              payload:
              [
                /* output:         */   output,     // 1 or 2
                /* P:              */   pid_p,      // Proportional (gain)
                /* I:              */   pid_i,      // Integral (reset)
                /* D:              */   pid_d       // Derivative (rate)
              ]
            },
            {
              cmd: "setp",
              payload:
              [
                /* output:         */   output,     // 1 or 2
                /* value:          */   pid_value   // respect the sensor units!
              ]
            },
            {
              cmd: "range",
              payload:
              [
                /* output:         */   output,     // 1 or 2
                /* range:          */   pid_range   // 0 = Off, 1 = Low, 2 = Medium, 3 = High
              ]
            }
          ]
        }),
        success: function(data, status) {
            alert("Data: " + data + "\nStatus: " + status);
        }
    });
}
function pid_off(output) {
    $.ajax({
        type: 'post',
        url: 'tmpr_do',
        contentType: "application/json; charset=utf-8",
        data: JSON.stringify({
          cmds:
          [
            {
              cmd: "outmode",
              payload:
              [
                /* output:         */   output,     // 1 or 2
                /* mode:           */   0,          // 0 = Off, 1 = Closed Loop PID, 2 = Zone, 3 = Open Loop, 4 = Monitor Out, 5 = Warmup Supply
                /* input:          */   0,          // 0 = None, 1 = A, 2 = B
                /* powerup_enable: */   0           // 0 = Off, 1 = On
              ]
            },
            {
              cmd: "range",
              payload:
              [
                /* output:         */   output,     // 1 or 2
                /* range:          */   0           // 0 = Off, 1 = Low, 2 = Medium, 3 = High
              ]
            }
          ]
        }),
        success: function(data, status) {
            alert("Data: " + data + "\nStatus: " + status);
        }
    });
}
</script>
{%- endif %}
</head>
<body>
<table class="state">
    <tr>
        <td>
            <table class="wide">
                {{ watch(title='Temperature A:', id='temperature1', value=temperatures[0], unit='K') }}
                {{ watch(title='Temperature B:', id='temperature2', value=temperatures[1], unit='K') }}
                {{ watch(title='Output 1:', id='output1', value=output[0], unit='%') }}
                {{ watch(title='Output 2:', id='output2', value=output[1], unit='%') }}
            </table>
        </td>
    </tr>
{% if master_mind -%}
    <tr>
        <td>
            <table class="wide" id="pid">
                <tr>
                    <td>
                        <table class="wide" id="pid_ch1">
                            <tr>
                                <td>Output:</td>
                                <td>
                                    <b>1</b>
                                </td>
                            </tr>
                            <tr>
                                <td>Input:</td>
                                <td>
                                    <select id="input_list">
                                        <option value="0">None</option>
                                        <option value="1" selected>A</option>
                                        <option value="2">B</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>Mode:</td>
                                <td>
                                    <select id="pid_mode_list">
                                        <option value="0">Off</option>
                                        <option value="1" selected>Closed Loop PID</option>
                                        <option value="2">Zone</option>
                                        <option value="3">Open Loop</option>
                                        <option value="4">Monitor Out</option>
                                        <option value="5">Warmup Supply</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>Range:</td>
                                <td>
                                    <select id="pid_range_list">
                                        <option value="0">Off</option>
                                        <option value="1">Low</option>
                                        <option value="2" selected>Medium</option>
                                        <option value="3">High</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>Powerup:</td>
                                <td>
                                    <select id="powerup_list">
                                        <option value="0">Off</option>
                                        <option value="1" selected>On</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>Desired value:</td>
                                <td>
                                    <input type='number' id="pid_value_field" value="292.73" step="0.01" min="0.00"/>
                                </td>
                            </tr>
                            <tr>
                                <td>P:</td>
                                <td>
                                    <input type='number' id="pid_p_field" value="50" step="any"/>
                                </td>
                            </tr>
                            <tr>
                                <td>I:</td>
                                <td>
                                    <input type='number' id="pid_i_field" value="20" step="any"/>
                                </td>
                            </tr>
                            <tr>
                                <td>D:</td>
                                <td>
                                    <input type='number' id="pid_d_field" value="0" step="any"/>
                                </td>
                            </tr>
                            <tr>
                                <td class="align_center" colspan=2>
                                    <input type="button" class="action_button" onclick="pid_on(1)" value="Turn PID on!">
                                    <input type="button" class="action_button" onclick="pid_off(1)" value="Turn PID off!">
                                </td>
                            </tr>
                        </table>
                    </td>
                    <td>
                        <table class="wide" id="pid_ch2">
                            <tr>
                                <td>Output:</td>
                                <td>
                                    <b>2</b>
                                </td>
                            </tr>
                            <tr>
                                <td>Input:</td>
                                <td>
                                    <select id="input_list">
                                        <option value="0">None</option>
                                        <option value="1">A</option>
                                        <option value="2" selected>B</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>Mode:</td>
                                <td>
                                    <select id="pid_mode_list">
                                        <option value="0">Off</option>
                                        <option value="1" selected>Closed Loop PID</option>
                                        <option value="2">Zone</option>
                                        <option value="3">Open Loop</option>
                                        <option value="4">Monitor Out</option>
                                        <option value="5">Warmup Supply</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>Range:</td>
                                <td>
                                    <select id="pid_range_list">
                                        <option value="0">Off</option>
                                        <option value="1">Low</option>
                                        <option value="2" selected>Medium</option>
                                        <option value="3">High</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>Powerup:</td>
                                <td>
                                    <select id="powerup_list">
                                        <option value="0">Off</option>
                                        <option value="1" selected>On</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>Desired value:</td>
                                <td>
                                    <input type='number' id="pid_value_field" value="292.73" step="0.01" min="0.00"/>
                                </td>
                            </tr>
                            <tr>
                                <td>P:</td>
                                <td>
                                    <input type='number' id="pid_p_field" value="50" step="any"/>
                                </td>
                            </tr>
                            <tr>
                                <td>I:</td>
                                <td>
                                    <input type='number' id="pid_i_field" value="20" step="any"/>
                                </td>
                            </tr>
                            <tr>
                                <td>D:</td>
                                <td>
                                    <input type='number' id="pid_d_field" value="0" step="any"/>
                                </td>
                            </tr>
                            <tr>
                                <td class="align_center" colspan=2>
                                    <input type="button" class="action_button" onclick="pid_on(2)" value="Turn PID on!">
                                    <input type="button" class="action_button" onclick="pid_off(2)" value="Turn PID off!">
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>
        </td>
    </tr>
{%- endif %}
    <tr>
        <td>
            <div id="chart"></div>
        </td>
    </tr>
    <tr>
        <td class="align_center">
            <table class="fixed centered">
                <tr>
                    <td>
                        <input type="checkbox" id="discard_data">
                        <label for="discard_data">Don't record temperatures</label>
                    </td>
                    <td>
                        <input type="button" id="clear" value="Clear Data">
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>

<audio preload="auto" id="warning">
    <source src="{{ url_for('static', filename='horse.ogg') }}" type="audio/ogg">
    <source src="{{ url_for('static', filename='horse.mp3') }}" type="audio/mpeg">
</audio>
</body>
</html>
